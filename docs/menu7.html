<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Four Solver</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ä¸Šéƒ¨ã«å¯„ã›ã‚‹ */
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            touch-action: manipulation; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ã‚’é˜²ã */
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 700px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(7, 60px); /* 7åˆ— */
            grid-template-rows: repeat(6, 60px);    /* 6è¡Œ */
            gap: 5px;
            background-color: #007bff; /* é’è‰²ã®ç›¤é¢ */
            padding: 10px;
            border-radius: 5px;
            margin: 20px auto;
            width: fit-content; /* å†…å®¹ã«åˆã‚ã›ã¦å¹…ã‚’èª¿æ•´ */
            position: relative; /* å­è¦ç´ ã®absoluteé…ç½®ã®åŸºæº– */
        }

        /* å„åˆ—ã®ä¸Šéƒ¨ã«é…ç½®ã™ã‚‹ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒªã‚¢ */
        .column-click-area {
            grid-row: 1 / span 6; /* 1è¡Œç›®ã‹ã‚‰6è¡Œç›®ã¾ã§å…¨ä½“ã‚’ã‚«ãƒãƒ¼ */
            z-index: 10; /* ã‚»ãƒ«ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
            cursor: pointer;
            /* ãƒ‡ãƒãƒƒã‚°ç”¨: ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒªã‚¢ã®ç¯„å›²ã‚’è¦‹ãŸã„å ´åˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™ */
            /* background-color: rgba(0, 255, 0, 0.1); */
        }

        .cell {
            width: 60px;
            height: 60px;
            background-color: #f0f8ff; /* ç©´ã®åˆæœŸè‰²ï¼ˆè–„ã„é’ï¼‰ */
            border-radius: 50%; /* ä¸¸ã„ç©´ */
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease-in-out;
            position: relative; /* ãƒ‡ã‚£ã‚¹ã‚¯ã®è‰²å¤‰æ›´ã‚’é‡ã­ã‚‹ãŸã‚ */
            z-index: 5; /* column-click-areaã‚ˆã‚Šå¥¥ */
            cursor: pointer; /* ãƒ‡ã‚£ã‚¹ã‚¯å‰Šé™¤ã®ãŸã‚ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ã« */
        }

        .cell.player1 {
            background-color: #ff4500; /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 (èµ¤) */
        }

        .cell.player2 {
            background-color: #000000; /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 (é»’) */
        }

        .controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .player-selection button {
            padding: 8px 15px;
            font-size: 15px;
            border: 2px solid;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .player-selection button.selected {
            font-weight: bold;
        }

        #select-player1 {
            background-color: #ffcccc;
            border-color: #ff4500;
        }
        #select-player1.selected {
            background-color: #ff4500;
            color: white;
        }

        #select-player2 {
            background-color: #cccccc;
            border-color: #000000;
            color: black;
        }
        #select-player2.selected {
            background-color: #000000;
            color: white;
        }

        #reset-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }

        #reset-button:hover {
            background-color: #218838;
        }

        .message {
            font-size: 18px;
            font-weight: bold;
            color: #555;
            margin-top: 10px;
        }

        .solver-suggestion {
            margin-top: 30px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            text-align: left;
        }

        .solver-suggestion h2 {
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 10px;
        }

        #solver-advice {
            font-size: 1.1em;
            color: #333;
            line-height: 1.6;
        }

        #solver-advice ul {
            list-style: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ */
            padding-left: 0;
            margin-top: 10px;
        }

        #solver-advice li {
            margin-bottom: 8px;
            padding-left: 25px; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ãŸã‚ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            position: relative;
        }

        #solver-advice li::before {
            content: 'ğŸ‘‰'; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ */
            position: absolute;
            left: 0;
            color: #007bff;
            font-size: 1.1em;
            line-height: 1; /* è¡Œã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
        }

        #solver-advice li.best::before {
            content: 'ğŸ‘‘'; /* æœ€é©è§£ */
            color: #ffd700; /* é‡‘è‰² */
        }

        #solver-advice li.win::before {
            content: 'âœ¨'; /* å‹åˆ©æ‰‹ */
            color: #28a745;
        }

        #solver-advice li.block::before {
            content: 'ğŸ›¡ï¸'; /* ãƒ–ãƒ­ãƒƒã‚¯æ‰‹ */
            color: #ffc107;
        }

        #solver-advice li.opportunity::before {
            content: 'ğŸ“ˆ'; /* ãƒãƒ£ãƒ³ã‚¹æ‰‹ */
            color: #17a2b8;
        }

        #solver-advice li.danger::before {
            content: 'âš ï¸'; /* å±é™ºãªæ‰‹ */
            color: #dc3545;
        }

        #solver-advice li.neutral::before {
            content: 'âšª'; /* ãã®ä»–ã®æ‰‹ */
            color: #6c757d;
        }

        #solver-advice li.info::before {
            content: 'â„¹ï¸'; /* æƒ…å ± */
            color: #6c757d;
        }

        .advice-history {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd; /* è–„ã„é’ */
            border-radius: 8px;
            text-align: left;
            max-height: 200px; /* é«˜ã•ã‚’åˆ¶é™ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
            overflow-y: auto;
            border: 1px solid #bbdefb;
        }

        .advice-history h3 {
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .advice-history .history-item {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #a7d9ff;
            font-size: 0.95em;
        }
        .advice-history .history-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .history-item strong {
            color: #333;
        }
        .history-item p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Connect Four Solver</h1>
        <div class="controls">
            <div class="player-selection">
                <p>é…ç½®ã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ:</p>
                <button id="select-player1" class="selected">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 (èµ¤)</button>
                <button id="select-player2">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 (é»’)</button>
            </div>
            <button id="reset-button">ç›¤é¢ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            <div class="message" id="message"></div>
        </div>
        <div id="game-board" class="game-board"></div>
        <div class="solver-suggestion">
            <h2>ã‚½ãƒ«ãƒãƒ¼ã®ææ¡ˆ</h2>
            <div id="solver-advice">ç›¤é¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...</div>
        </div>
        <div class="advice-history">
            <h3>éå»ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹å±¥æ­´</h3>
            <div id="history-content">
                <p class="info">ã“ã“ã«éå»ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        const ROWS = 6;
        const COLS = 7;
        const EMPTY = 0;
        const PLAYER1 = 1; // èµ¤
        const PLAYER2 = 2; // é»’

        let board = [];
        let selectedPlayer = PLAYER1; // ç¾åœ¨é…ç½®ã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        const adviceHistory = []; // ã‚¢ãƒ‰ãƒã‚¤ã‚¹å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é…åˆ—

        const gameBoardElement = document.getElementById('game-board');
        const resetButton = document.getElementById('reset-button');
        const messageElement = document.getElementById('message');
        const solverAdviceElement = document.getElementById('solver-advice');
        const selectPlayer1Button = document.getElementById('select-player1');
        const selectPlayer2Button = document.getElementById('select-player2');
        const historyContentElement = document.getElementById('history-content');

        // ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã®åˆæœŸåŒ–
        function initializeBoard() {
            board = Array(ROWS).fill(0).map(() => Array(COLS).fill(EMPTY));
            selectedPlayer = PLAYER1; // ãƒªã‚»ãƒƒãƒˆæ™‚ã¯èµ¤ã‚’é¸æŠ
            adviceHistory.length = 0; // å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
            updatePlayerSelectionButtons();
            renderBoard();
            updateMessage(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 (èµ¤) ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’é…ç½®ã§ãã¾ã™`);
            updateSolverAdvice();
            renderHistory(); // å±¥æ­´ã‚‚åˆæœŸåŒ–
        }

        // ãƒœãƒ¼ãƒ‰ã®æç”»
        function renderBoard() {
            gameBoardElement.innerHTML = ''; // æ—¢å­˜ã®è¦ç´ ã‚’ã‚¯ãƒªã‚¢

            // å„åˆ—ã®ä¸Šéƒ¨ã«ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚¨ãƒªã‚¢ã‚’ä½œæˆï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç½®ããŸã‚ï¼‰
            for (let c = 0; c < COLS; c++) {
                const columnClickArea = document.createElement('div');
                columnClickArea.classList.add('column-click-area');
                columnClickArea.dataset.col = c;
                columnClickArea.style.gridColumn = `${c + 1}`;
                columnClickArea.addEventListener('click', handleColumnClick);
                gameBoardElement.appendChild(columnClickArea);
            }

            // ã‚²ãƒ¼ãƒ ã‚»ãƒ«ã‚’æç”»
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    if (board[r][c] === PLAYER1) {
                        cell.classList.add('player1');
                    } else if (board[r][c] === PLAYER2) {
                        cell.classList.add('player2');
                    }
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.style.gridRow = `${r + 1}`;
                    cell.style.gridColumn = `${c + 1}`;
                    // ãƒ‡ã‚£ã‚¹ã‚¯å‰Šé™¤ã®ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                    cell.addEventListener('click', handleCellClick);
                    gameBoardElement.appendChild(cell);
                }
            }
        }

        // åˆ—å…¨ä½“ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç½®ãï¼‰
        function handleColumnClick(event) {
            const col = parseInt(event.target.dataset.col);
            if (dropDisc(col, selectedPlayer)) {
                updateMessage(`åˆ— ${col + 1} ã«${selectedPlayer === PLAYER1 ? 'èµ¤' : 'é»’'}ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’é…ç½®ã—ã¾ã—ãŸã€‚`);
                updateSolverAdvice(); // ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ›´æ–°
            } else {
                updateMessage('ãã®åˆ—ã¯æº€æ¯ã§ã™ã€‚åˆ¥ã®åˆ—ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
            }
        }

        // ã‚»ãƒ«ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ï¼‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ã‚’æ¶ˆã™ï¼‰
        function handleCellClick(event) {
            const row = parseInt(event.target.dataset.row);
            const col = parseInt(event.target.dataset.col);

            if (board[row][col] !== EMPTY) {
                const originalPlayer = board[row][col]; // ã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‡ã‚£ã‚¹ã‚¯ã ã£ãŸã‹
                board[row][col] = EMPTY; // ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç©ºã«ã™ã‚‹

                // æ¶ˆã—ãŸãƒ‡ã‚£ã‚¹ã‚¯ã®ä¸Šã«ã‚ã‚‹ãƒ‡ã‚£ã‚¹ã‚¯ã‚’è½ã¨ã™ï¼ˆé‡åŠ›ãƒ«ãƒ¼ãƒ«ï¼‰
                // æ¶ˆã—ãŸè¡Œã‚ˆã‚Šä¸Šã«ã‚ã‚‹ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯ã—ã€å†é…ç½®ã™ã‚‹
                for (let rCheck = row - 1; rCheck >= 0; rCheck--) {
                    if (board[rCheck][col] !== EMPTY) {
                        const discToMove = board[rCheck][col];
                        board[rCheck][col] = EMPTY; // ä¸€åº¦å‰Šé™¤
                        // å†åº¦ã€ãã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’åŒã˜åˆ—ã®æœ€ã‚‚ä½ã„ä½ç½®ã«ãƒ‰ãƒ­ãƒƒãƒ—
                        dropDisc(col, discToMove);
                    }
                }
                renderBoard();
                updateMessage(`åˆ— ${col + 1}, è¡Œ ${row + 1} ã®${originalPlayer === PLAYER1 ? 'èµ¤' : 'é»’'}ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                updateSolverAdvice(); // ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ›´æ–°
            }
        }


        // ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹
        function dropDisc(col, player, currentBoard = board) {
            for (let r = ROWS - 1; r >= 0; r--) {
                if (currentBoard[r][col] === EMPTY) {
                    currentBoard[r][col] = player;
                    // å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã«ã®ã¿æç”»ã‚’åæ˜ 
                    if (currentBoard === board) {
                        renderBoard();
                    }
                    return true;
                }
            }
            return false; // ãã®åˆ—ã¯æº€æ¯
        }

        // å‹æ•—åˆ¤å®š
        function checkWin(player, currentBoard = board) {
            // æ°´å¹³æ–¹å‘
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c <= COLS - 4; c++) {
                    if (currentBoard[r][c] === player &&
                        currentBoard[r][c+1] === player &&
                        currentBoard[r][c+2] === player &&
                        currentBoard[r][c+3] === player) {
                        return true;
                    }
                }
            }

            // å‚ç›´æ–¹å‘
            for (let r = 0; r <= ROWS - 4; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (currentBoard[r][c] === player &&
                        currentBoard[r+1][c] === player &&
                        currentBoard[r+2][c] === player &&
                        currentBoard[r+3][c] === player) {
                        return true;
                    }
                }
            }

            // å³ä¸‹ãŒã‚Šæ–œã‚
            for (let r = 0; r <= ROWS - 4; r++) {
                for (let c = 0; c <= COLS - 4; c++) {
                    if (currentBoard[r][c] === player &&
                        currentBoard[r+1][c+1] === player &&
                        currentBoard[r+2][c+2] === player &&
                        currentBoard[r+3][c+3] === player) {
                        return true;
                    }
                }
            }

            // å³ä¸ŠãŒã‚Šæ–œã‚
            for (let r = 3; r < ROWS; r++) {
                for (let c = 0; c <= COLS - 4; c++) {
                    if (currentBoard[r][c] === player &&
                        currentBoard[r-1][c+1] === player &&
                        currentBoard[r-2][c+2] === player &&
                        currentBoard[r-3][c+3] === player) {
                        return true;
                    }
                }
            }

            return false;
        }

        // ãƒœãƒ¼ãƒ‰ãŒæº€æ¯ã‹ãƒã‚§ãƒƒã‚¯
        function isBoardFull(currentBoard = board) {
            return currentBoard[0].every(cell => cell !== EMPTY);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°
        function updateMessage(msg) {
            messageElement.textContent = msg;
        }

        // ã‚½ãƒ«ãƒãƒ¼ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ›´æ–°
        function updateSolverAdvice() {
            const currentBoardString = JSON.stringify(board); // ç¾åœ¨ã®ç›¤é¢ã‚’æ–‡å­—åˆ—åŒ–ã—ã¦å±¥æ­´ã«è¿½åŠ 
            const currentAdvice = getSolverAdvice(selectedPlayer);
            solverAdviceElement.innerHTML = currentAdvice;

            // å±¥æ­´ã«è¿½åŠ 
            const timestamp = new Date().toLocaleTimeString();
            adviceHistory.unshift({ // æœ€æ–°ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…ˆé ­ã«è¿½åŠ 
                time: timestamp,
                player: selectedPlayer,
                advice: currentAdvice,
                boardState: currentBoardString // ç›¤é¢ã®çŠ¶æ…‹ã‚‚ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            });
            renderHistory();
        }

        // æŒ‡å®šã—ãŸåˆ—ã§æ¬¡ã«ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç½®ã‘ã‚‹è¡Œã‚’å–å¾—
        function getNextAvailableRow(col, currentBoard = board) {
            for (let r = ROWS - 1; r >= 0; r--) {
                if (currentBoard[r][col] === EMPTY) {
                    return r;
                }
            }
            return -1; // ãã®åˆ—ã¯æº€æ¯
        }

        // Nå€‹é€£ç¶šã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹è£œåŠ©é–¢æ•°ï¼ˆç‰¹å®šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¨ã¦ã®Nå€‹é€£ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ•°ãˆã‚‹ï¼‰
        // ç›¸æ‰‹ã®ãƒ‡ã‚£ã‚¹ã‚¯ãŒé–“ã«ã‚ã‚‹å ´åˆã¯é€£ç¶šã¨ã¿ãªã•ãªã„
        function countNInARow(currentBoard, player, count) {
            let totalCount = 0;
            const opponent = (player === PLAYER1) ? PLAYER2 : PLAYER1;

            // æ°´å¹³
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c <= COLS - count; c++) {
                    let currentPlayerCount = 0;
                    let opponentCount = 0;
                    for (let i = 0; i < count; i++) {
                        if (currentBoard[r][c + i] === player) {
                            currentPlayerCount++;
                        } else if (currentBoard[r][c + i] === opponent) {
                            opponentCount++;
                        }
                    }
                    if (currentPlayerCount === count && opponentCount === 0) totalCount++;
                }
            }

            // å‚ç›´
            for (let r = 0; r <= ROWS - count; r++) {
                for (let c = 0; c < COLS; c++) {
                    let currentPlayerCount = 0;
                    let opponentCount = 0;
                    for (let i = 0; i < count; i++) {
                        if (currentBoard[r + i][c] === player) {
                            currentPlayerCount++;
                        } else if (currentBoard[r + i][c] === opponent) {
                            opponentCount++;
                        }
                    }
                    if (currentPlayerCount === count && opponentCount === 0) totalCount++;
                }
            }

            // å³ä¸‹ãŒã‚Šæ–œã‚
            for (let r = 0; r <= ROWS - count; r++) {
                for (let c = 0; c <= COLS - count; c++) {
                    let currentPlayerCount = 0;
                    let opponentCount = 0;
                    for (let i = 0; i < count; i++) {
                        if (currentBoard[r + i][c + i] === player) {
                            currentPlayerCount++;
                        } else if (currentBoard[r + i][c + i] === opponent) {
                            opponentCount++;
                        }
                    }
                    if (currentPlayerCount === count && opponentCount === 0) totalCount++;
                }
            }

            // å³ä¸ŠãŒã‚Šæ–œã‚
            for (let r = count - 1; r < ROWS; r++) {
                for (let c = 0; c <= COLS - count; c++) {
                    let currentPlayerCount = 0;
                    let opponentCount = 0;
                    for (let i = 0; i < count; i++) {
                        if (currentBoard[r - i][c + i] === player) {
                            currentPlayerCount++;
                        } else if (currentBoard[r - i][c + i] === opponent) {
                            opponentCount++;
                        }
                    }
                    if (currentPlayerCount === count && opponentCount === 0) totalCount++;
                }
            }
            return totalCount;
        }

        // é–‹ã„ã¦ã„ã‚‹Nå€‹ä¸¦ã³ï¼ˆé–“ã«ãƒ‡ã‚£ã‚¹ã‚¯ãŒç½®ã‘ã‚‹ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚‹Nå€‹ä¸¦ã³ï¼‰ã‚’æ•°ãˆã‚‹
        function countOpenNInARow(currentBoard, player, targetLength) {
            let totalCount = 0;
            const opponent = (player === PLAYER1) ? PLAYER2 : PLAYER1;

            // æ°´å¹³
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c <= COLS - targetLength; c++) {
                    let playerCount = 0;
                    let emptyCount = 0;
                    let isValidPath = true;
                    for (let i = 0; i < targetLength; i++) {
                        if (currentBoard[r][c + i] === player) {
                            playerCount++;
                        } else if (currentBoard[r][c + i] === EMPTY) {
                            // ç©ºããƒã‚¹ãŒã€Œç½®ã‘ã‚‹ã€ä½ç½®ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            if (r === ROWS - 1 || currentBoard[r + 1][c + i] !== EMPTY) {
                                emptyCount++;
                            } else {
                                isValidPath = false; // ç©ºããƒã‚¹ã®ä¸‹ã«ç©ºããŒã‚ã‚‹ãŸã‚ã€ã“ã®ãƒ‘ã‚¹ã¯ç„¡åŠ¹
                                break;
                            }
                        } else { // ç›¸æ‰‹ã®ãƒ‡ã‚£ã‚¹ã‚¯
                            isValidPath = false; // ç›¸æ‰‹ã®ãƒ‡ã‚£ã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚ã€ã“ã®ãƒ‘ã‚¹ã¯ç„¡åŠ¹
                            break;
                        }
                    }
                    if (isValidPath && playerCount === targetLength - 1 && emptyCount === 1) {
                        totalCount++;
                    }
                }
            }

            // å‚ç›´
            for (let r = 0; r <= ROWS - targetLength; r++) {
                for (let c = 0; c < COLS; c++) {
                    let playerCount = 0;
                    let emptyCount = 0;
                    let isValidPath = true;
                    for (let i = 0; i < targetLength; i++) {
                        if (currentBoard[r + i][c] === player) {
                            playerCount++;
                        } else if (currentBoard[r + i][c] === EMPTY) {
                            // ç©ºããƒã‚¹ãŒã€Œç½®ã‘ã‚‹ã€ä½ç½®ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            if (r + i === ROWS - 1 || currentBoard[r + i + 1][c] !== EMPTY) {
                                emptyCount++;
                            } else {
                                isValidPath = false;
                                break;
                            }
                        } else {
                            isValidPath = false;
                            break;
                        }
                    }
                    if (isValidPath && playerCount === targetLength - 1 && emptyCount === 1) {
                        totalCount++;
                    }
                }
            }

            // å³ä¸‹ãŒã‚Šæ–œã‚
            for (let r = 0; r <= ROWS - targetLength; r++) {
                for (let c = 0; c <= COLS - targetLength; c++) {
                    let playerCount = 0;
                    let emptyCount = 0;
                    let isValidPath = true;
                    for (let i = 0; i < targetLength; i++) {
                        if (currentBoard[r + i][c + i] === player) {
                            playerCount++;
                        } else if (currentBoard[r + i][c + i] === EMPTY) {
                            if (r + i === ROWS - 1 || currentBoard[r + i + 1][c + i] !== EMPTY) {
                                emptyCount++;
                            } else {
                                isValidPath = false;
                                break;
                            }
                        } else {
                            isValidPath = false;
                            break;
                        }
                    }
                    if (isValidPath && playerCount === targetLength - 1 && emptyCount === 1) {
                        totalCount++;
                    }
                }
            }

            // å³ä¸ŠãŒã‚Šæ–œã‚
            for (let r = targetLength - 1; r < ROWS; r++) {
                for (let c = 0; c <= COLS - targetLength; c++) {
                    let playerCount = 0;
                    let emptyCount = 0;
                    let isValidPath = true;
                    for (let i = 0; i < targetLength; i++) {
                        if (currentBoard[r - i][c + i] === player) {
                            playerCount++;
                        } else if (currentBoard[r - i][c + i] === EMPTY) {
                            if (r - i === ROWS - 1 || currentBoard[r - i + 1][c + i] !== EMPTY) {
                                emptyCount++;
                            } else {
                                isValidPath = false;
                                break;
                            }
                        } else {
                            isValidPath = false;
                            break;
                        }
                    }
                    if (isValidPath && playerCount === targetLength - 1 && emptyCount === 1) {
                        totalCount++;
                    }
                }
            }
            return totalCount;
        }


        // ãƒœãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function copyBoard(originalBoard) {
            return originalBoard.map(row => [...row]);
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
        function updatePlayerSelectionButtons() {
            selectPlayer1Button.classList.remove('selected');
            selectPlayer2Button.classList.remove('selected');
            if (selectedPlayer === PLAYER1) {
                selectPlayer1Button.classList.add('selected');
            } else {
                selectPlayer2Button.classList.add('selected');
            }
            updateMessage(`ç¾åœ¨ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${selectedPlayer === PLAYER1 ? '1 (èµ¤)' : '2 (é»’)'} ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’é…ç½®ã§ãã¾ã™`);
        }

        // ã‚½ãƒ«ãƒãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function getSolverAdvice(player) {
            const opponent = (player === PLAYER1) ? PLAYER2 : PLAYER1;
            let adviceHtml = '<ul>'; // ãƒªã‚¹ãƒˆå½¢å¼ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ§‹æˆ
            const playerColorName = player === PLAYER1 ? 'èµ¤' : 'é»’';
            const opponentColorName = opponent === PLAYER1 ? 'èµ¤' : 'é»’';

            const possibleMoves = []; // { col: int, score: int, description: string, type: string }

            // ã‚²ãƒ¼ãƒ çµ‚äº†åˆ¤å®š
            if (checkWin(PLAYER1, board)) {
                return `<p class="info">ã‚²ãƒ¼ãƒ ã¯<strong style="color: #ff4500;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 (èµ¤)</strong>ã®å‹åˆ©ã§çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã§æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>`;
            }
            if (checkWin(PLAYER2, board)) {
                return `<p class="info">ã‚²ãƒ¼ãƒ ã¯<strong style="color: #000000;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 (é»’)</strong>ã®å‹åˆ©ã§çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã§æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>`;
            }
            if (isBoardFull(board)) {
                return `<p class="info">ç›¤é¢ãŒæº€æ¯ã§ã™ã€‚å¼•ãåˆ†ã‘ã§ã™ã€‚ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã§æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>`;
            }

            for (let c = 0; c < COLS; c++) {
                const r = getNextAvailableRow(c);
                if (r === -1) {
                    possibleMoves.push({ col: c, score: -Infinity, description: `åˆ— ${c + 1} ã¯æº€æ¯ã§ã™ã€‚`, type: 'info' });
                    continue;
                }

                const tempBoard = copyBoard(board);
                tempBoard[r][c] = player;

                let score = 0;
                let desc = `åˆ— ${c + 1}`;
                let type = 'neutral'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¿ã‚¤ãƒ—

                // 1. è‡ªåˆ†ã®å‹åˆ©æ‰‹
                if (checkWin(player, tempBoard)) {
                    score += 100000; // éå¸¸ã«é«˜ã„ã‚¹ã‚³ã‚¢
                    desc += ` - ã“ã®æ‰‹ã§**${playerColorName}ã®å‹åˆ©ãŒç¢ºå®šã—ã¾ã™ï¼**`;
                    type = 'win';
                }
                // 2. ç›¸æ‰‹ã®å‹åˆ©ã‚’ãƒ–ãƒ­ãƒƒã‚¯
                else {
                    const opponentTempBoard = copyBoard(tempBoard); // è‡ªåˆ†ãŒç½®ã„ãŸå¾Œã®ç›¤é¢
                    let foundOpponentWin = false;
                    for (let oc = 0; oc < COLS; oc++) {
                        const or = getNextAvailableRow(oc, opponentTempBoard);
                        if (or !== -1) {
                            opponentTempBoard[or][oc] = opponent; // ç›¸æ‰‹ãŒç½®ã„ãŸã¨ä»®å®š
                            if (checkWin(opponent, opponentTempBoard)) {
                                foundOpponentWin = true;
                                break;
                            }
                            opponentTempBoard[or][oc] = EMPTY; // å…ƒã«æˆ»ã™
                        }
                    }
                    if (foundOpponentWin) {
                        score += 50000; // ãƒ–ãƒ­ãƒƒã‚¯ã¯é«˜å¾—ç‚¹
                        desc += ` - ç›¸æ‰‹ï¼ˆ${opponentColorName}ï¼‰ã®**å‹åˆ©ã‚’é˜²ã**ã“ã¨ãŒã§ãã¾ã™ã€‚`;
                        type = 'block';
                    }
                }

                // 3. è‡ªåˆ†ã®3ã¤ä¸¦ã³ãƒãƒ£ãƒ³ã‚¹ (æ¬¡ã®æ‰‹ã§4ã¤ã«ãªã‚‹å¯èƒ½æ€§)
                const playerOpenThrees = countOpenNInARow(tempBoard, player, 4); // 4ã¤ä¸¦ã³ãŒä½œã‚Œã‚‹å ´æ‰€ (3ã¤ï¼‹ç©ºã)
                if (playerOpenThrees > 0) {
                    // æ—¢ã«å‹åˆ©æ‰‹ã‚„ãƒ–ãƒ­ãƒƒã‚¯æ‰‹ã§ãªã„å ´åˆã®ã¿ã‚¿ã‚¤ãƒ—ã‚’æ›´æ–°
                    if (type === 'neutral') type = 'opportunity';
                    score += playerOpenThrees * 1000;
                    desc += ` - ${playerColorName}ã®**4ã¤ä¸¦ã³ã®ãƒãƒ£ãƒ³ã‚¹** (${playerOpenThrees}ã‹æ‰€) ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚`;
                }

                // 4. ç›¸æ‰‹ã®3ã¤ä¸¦ã³ãƒãƒ£ãƒ³ã‚¹ (ç›¸æ‰‹ãŒæ¬¡ã®æ‰‹ã§4ã¤ã«ãªã‚‹å¯èƒ½æ€§) - ã“ã‚Œã¯è‡ªåˆ†ãŒãƒ–ãƒ­ãƒƒã‚¯ã™ã¹ãã‚‚ã®
                const opponentOpenThrees = countOpenNInARow(tempBoard, opponent, 4);
                if (opponentOpenThrees > 0) {
                    if (type === 'neutral' || type === 'opportunity') type = 'danger'; // å±é™ºåº¦ãŒä¸ŠãŒã‚Œã°ã‚¿ã‚¤ãƒ—æ›´æ–°
                    score -= opponentOpenThrees * 800; // ç›¸æ‰‹ã«ãƒãƒ£ãƒ³ã‚¹ã‚’ä¸ãˆã‚‹ã¨æ¸›ç‚¹
                    desc += ` - ã“ã®æ‰‹ã‚’ç½®ãã¨ã€ç›¸æ‰‹ã«**4ã¤ä¸¦ã³ã®ãƒãƒ£ãƒ³ã‚¹** (${opponentOpenThrees}ã‹æ‰€) ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
                }

                // 5. ä¸­å¤®ã®åˆ—ã‚’å„ªå…ˆ (æˆ¦ç•¥çš„ãªåˆ©ç‚¹)
                const centerColumnScore = [0, 1, 2, 3, 2, 1, 0]; // ä¸­å¤®ã«è¿‘ã„ã»ã©é«˜ã„ã‚¹ã‚³ã‚¢
                score += centerColumnScore[c] * 10;
                if (centerColumnScore[c] === 3 && type === 'neutral') { // ä»–ã®å„ªå…ˆåº¦ãŒé«˜ã„æ‰‹ã§ãªã‘ã‚Œã°
                    desc += ` - ä¸­å¤®ã®åˆ—ã§æœ‰åˆ©ãªä½ç½®ã§ã™ã€‚`;
                }

                possibleMoves.push({ col: c, score: score, description: desc, type: type });
            }

            // ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆ (é«˜ã„ã‚¹ã‚³ã‚¢ãŒä¸Šä½)
            possibleMoves.sort((a, b) => b.score - a.score);

            if (possibleMoves.length === 0 || possibleMoves[0].score === -Infinity) {
                return '<p class="info">ç¾åœ¨ã€ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç½®ã‘ã‚‹å ´æ‰€ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }

            // --- ã‚½ãƒ«ãƒãƒ¼ã®ææ¡ˆã®è¡¨ç¤º ---
            const bestMove = possibleMoves[0];

            adviceHtml += `<li class="best"><strong>æœ€é©ãªä¸€æ‰‹:</strong> åˆ— ${bestMove.col + 1} ã«ç½®ãã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚${bestMove.description.replace(`åˆ— ${bestMove.col + 1} - `, '')}</li>`;

            adviceHtml += `<li><strong style="color: #0056b3;">ãã®ä»–ã®è€ƒæ…®ã™ã¹ãæ‰‹:</strong></li>`;
            let otherMovesCount = 0;
            for (let i = 1; i < possibleMoves.length; i++) {
                const move = possibleMoves[i];
                if (move.score > -Infinity) { // æº€æ¯ã§ãªã„åˆ—ã®ã¿
                    adviceHtml += `<li class="${move.type}">${move.description} (ã‚¹ã‚³ã‚¢: ${move.score})</li>`;
                    otherMovesCount++;
                    if (otherMovesCount >= 3) break; // ä¸Šä½3ã¤ç¨‹åº¦ã§ååˆ†
                }
            }
            if (otherMovesCount === 0) {
                adviceHtml += `<li class="info">ä»–ã«ç›®ç«‹ã£ãŸæ¨å¥¨æ‰‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>`;
            }

            // --- ç›¸æ‰‹ã®è¦–ç‚¹ã§ã®è¿½åŠ æƒ…å ± ---
            adviceHtml += `<br><li><strong style="color: #0056b3;">ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆ${opponentColorName}ï¼‰ã®è¦–ç‚¹:</strong></li>`;
            let opponentNextMoves = [];
            for (let c = 0; c < COLS; c++) {
                const r = getNextAvailableRow(c);
                if (r !== -1) {
                    const tempBoard = copyBoard(board);
                    tempBoard[r][c] = opponent; // ç›¸æ‰‹ãŒç½®ã„ãŸã¨ä»®å®š
                    if (checkWin(opponent, tempBoard)) {
                        opponentNextMoves.push(`åˆ— ${c + 1} (å‹åˆ©æ‰‹)`);
                    } else if (countOpenNInARow(tempBoard, opponent, 4) > 0) {
                        opponentNextMoves.push(`åˆ— ${c + 1} (4ã¤ä¸¦ã³ã®ãƒãƒ£ãƒ³ã‚¹)`);
                    }
                }
            }
            if (opponentNextMoves.length > 0) {
                adviceHtml += `<li class="danger">ã‚‚ã—ç›¸æ‰‹ã®ç•ªã ã£ãŸã‚‰ã€**${opponentNextMoves.join(', ')}**ã®ã‚ˆã†ãªæ‰‹ã‚’è€ƒãˆã¦ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</li>`;
            } else {
                adviceHtml += `<li class="info">ç›¸æ‰‹ã¯æ¬¡ã®æ‰‹ã§ç›´æ¥çš„ãªå‹åˆ©æ‰‹ã‚„æ˜ç¢ºãª4ã¤ä¸¦ã³ã®ãƒãƒ£ãƒ³ã‚¹ã¯å°‘ãªã„ã‚ˆã†ã§ã™ã€‚</li>`;
            }

            adviceHtml += `<li class="info"><em>â€»ã“ã®ã‚½ãƒ«ãƒãƒ¼ã¯ç°¡æ˜“çš„ãªãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ã«åŸºã¥ã„ã¦ãŠã‚Šã€ã™ã¹ã¦ã®æœ€é©è§£ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ˆã‚Šè¤‡é›‘ãªçŠ¶æ³ã§ã¯ã€Minimaxãªã©ã®é«˜åº¦ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒå¿…è¦ã§ã™ã€‚</em></li>`;
            adviceHtml += '</ul>';

            return adviceHtml;
        }

        // å±¥æ­´ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderHistory() {
            historyContentElement.innerHTML = '';
            if (adviceHistory.length === 0) {
                historyContentElement.innerHTML = '<p class="info">ã“ã“ã«éå»ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
                return;
            }

            // æœ€æ–°ã®3ã¤ç¨‹åº¦ã ã‘è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«åˆ¶é™
            const maxHistoryItems = 3;
            for (let i = 0; i < Math.min(adviceHistory.length, maxHistoryItems); i++) {
                const item = adviceHistory[i];
                const historyItemDiv = document.createElement('div');
                historyItemDiv.classList.add('history-item');
                historyItemDiv.innerHTML = `
                    <p><strong>${item.time} - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${item.player === PLAYER1 ? '1 (èµ¤)' : '2 (é»’)'} ã®ç•ª:</strong></p>
                    ${item.advice}
                `;
                historyContentElement.appendChild(historyItemDiv);
            }
        }


        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        resetButton.addEventListener('click', initializeBoard);
        selectPlayer1Button.addEventListener('click', () => {
            selectedPlayer = PLAYER1;
            updatePlayerSelectionButtons();
            updateSolverAdvice(); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´æ™‚ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ›´æ–°
        });
        selectPlayer2Button.addEventListener('click', () => {
            selectedPlayer = PLAYER2;
            updatePlayerSelectionButtons();
            updateSolverAdvice(); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´æ™‚ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ›´æ–°
        });

        // åˆæœŸæç”»
        initializeBoard();
    </script>
</body>
</html>
